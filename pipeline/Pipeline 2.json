{
	"name": "Pipeline 2",
	"properties": {
		"activities": [
			{
				"name": "Script1",
				"type": "Script",
				"dependsOn": [],
				"policy": {
					"timeout": "0.12:00:00",
					"retry": 0,
					"retryIntervalInSeconds": 30,
					"secureOutput": false,
					"secureInput": false
				},
				"userProperties": [],
				"linkedServiceName": {
					"referenceName": "LS_ASQL",
					"type": "LinkedServiceReference",
					"parameters": {
						"ASQL_ServerName": {
							"value": "trainparmish-ondemand.sql.azuresynapse.net",
							"type": "Expression"
						},
						"ASQLDB_Name": {
							"value": "@pipeline().parameters.DBName",
							"type": "Expression"
						}
					}
				},
				"typeProperties": {
					"scripts": [
						{
							"parameters": [
								{
									"name": "ServerlessSQLDB_BalancedScorecardDataset_Input",
									"type": "String",
									"value": {
										"value": "BalancedScorecardDataset",
										"type": "Expression"
									},
									"direction": "Input"
								},
								{
									"name": "ServerlessSQLDB_BalancedScorecardDataset_StorageAccountName_Input",
									"type": "String",
									"value": {
										"value": "rawtrg",
										"type": "Expression"
									},
									"direction": "Input"
								}
							],
							"type": "NonQuery",
							"text": "DECLARE @ServerlessSQLDB_BalancedScorecardDataset nvarchar(255) = @ServerlessSQLDB_BalancedScorecardDataset_Input\r\nDECLARE @ServerlessSQLDB_BalancedScorecardDataset_StorageAccountName nvarchar(255) = @ServerlessSQLDB_BalancedScorecardDataset_StorageAccountName_Input\r\nDECLARE @DynamicSQL nvarchar(4000) --Must be of type nvarchar as sp_executesql doesn't accept varchar type\r\nDECLARE @Exists bit\r\n--Check if the database already exists\r\nSET @DynamicSQL =\r\n'IF DB_ID(@ServerlessSQLDB_BalancedScorecardDataset_in) IS NOT NULL\r\nBEGIN\r\n    SELECT @Exists_Out = 1\r\nEND\r\nELSE\r\nBEGIN\r\n    SELECT @Exists_Out = 0\r\nEND'\r\n--Use sp_executesql to get the output parameter.\r\nEXEC sp_executesql\r\n    @DynamicSQL\r\n    , N'@ServerlessSQLDB_BalancedScorecardDataset_in varchar(255), @Exists_Out bit output'\r\n    , @ServerlessSQLDB_BalancedScorecardDataset_In = @ServerlessSQLDB_BalancedScorecardDataset\r\n    , @Exists_Out = @Exists OUTPUT\r\n--If database does not exist, create database and external data source\r\nIF (@Exists = 0)\r\nBEGIN\r\n    SET @DynamicSQL =\r\n        '--Create the Database\r\n        CREATE DATABASE ['+@ServerlessSQLDB_BalancedScorecardDataset+']\r\n        COLLATE Latin1_General_100_CI_AS_SC_UTF8;\r\n        '\r\n    EXEC (@DynamicSQL)\r\n    SET @DynamicSQL =\r\n        'USE ['+@ServerlessSQLDB_BalancedScorecardDataset+'];\r\n        --Create the Master Key\r\n        CREATE MASTER KEY;\r\n        --Create the Database Scoped Credential\r\n        CREATE DATABASE SCOPED CREDENTIAL SynapseManagedIdentity\r\n        WITH IDENTITY = ''Managed Identity'';\r\n        --Create the data lake external data source\r\n        CREATE EXTERNAL DATA SOURCE DataLakeDataSource\r\n        WITH (\r\n            LOCATION=''https://'+@ServerlessSQLDB_BalancedScorecardDataset_StorageAccountName+'.dfs.core.windows.net/'',\r\n            CREDENTIAL = SynapseManagedIdentity\r\n        );'\r\n    EXEC (@DynamicSQL)\r\nEND"
						}
					],
					"scriptBlockExecutionTimeout": "02:00:00"
				}
			}
		],
		"parameters": {
			"DBName": {
				"type": "string",
				"defaultValue": "BalancedScorecard_DB"
			}
		},
		"annotations": [],
		"lastPublishTime": "2024-03-22T08:39:53Z"
	},
	"type": "Microsoft.Synapse/workspaces/pipelines"
}